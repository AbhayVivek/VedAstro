@attribute [Route(PageRoute.Horoscope)]

@inject HttpClient Client


<PageTitle>Horoscope</PageTitle>
<PageTop Title="Horoscope" IconName="fluent:book-star-20-filled">
    <Description>Astrological predictions of a person's horoscope</Description>
    <ButtonsRow>
        <IconButton IconName="ant-design:user-add-outlined" ButtonText="Add Person" ClickUrl="@PageRoute.AddPerson"></IconButton>
        <IconButton IconName="carbon:graphical-data-flow" ButtonText="Horoscope Data" ClickUrl="@PageRoute.HoroscopeData"></IconButton>
        <IconButton IconName="bx:book-reader" ButtonText="Help" OnClickCallback="@_helpSection.Show"></IconButton>
    </ButtonsRow>
</PageTop>



<div>

    <div class="d-flex flex-wrap">
        <div class="vstack gap-3">
            <PeopleSelectorBox @ref="_peopleSelectorBox" />
            <IconButton IconName="uim:process" ButtonText="Calculate" OnClickCallback="CalculateButtonClicked"></IconButton>
        </div>
        <div class="alert alert-warning d-flex align-items-center w-50" role="alert">
            <span class="iconify bi flex-shrink-0 me-2" data-icon="ant-design:warning-twotone" data-width="50"></span>
            <div>
                <strong>Remember!</strong><br />
                Results shown here need to be combined with <a href="@PageRoute.HoroscopeData"><span class="fw-bold">Astrological Data</span></a> to get accurate predictions.
            </div>
        </div>
    </div>


    @*Only show table and search after button clicked*@
    <div @ref="holder" class="vstack gap-2" style="display: none;">
        <hr />
        <div class="hstack gap-3">
            <input @bind="_searchInput" type="text" class="form-control" placeholder="Search">
            <IconButton ButtonText="Search" IconName="bx:search-alt" OnClickCallback="SearchButtonClicked"></IconButton>
        </div>

        <table class="table table-bordered table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th style="min-width: 123px;">Info</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var prediction in _filteredHoroscopePredictions)
                {
                    <tr>
                        <td>@prediction.FormattedName</td>
                        <td>@prediction.Description</td>
                        <td>@prediction.Info</td>
                    </tr>
                }
            </tbody>
        </table>

    </div>

    @*HELP SECTION*@
    <PageHelpSection @ref="_helpSection">
        <Content>
            <h4 class="fw-bold">Where are these predictions from?</h4>
            <p class="text-justify mb-4" style="max-width:@AppData.MaxWidth;">
                Prediction data come from books by renowned astrologer B.V. Raman.
                Books such as <span class="fw-bold">How to Judge Horoscope</span> and
                <span class="fw-bold">Hindu Predictive Astrology</span>,
                were used to make this calculator.
            </p>

            <h4 class="fw-bold">How to use these predictions?</h4>
            <p class="text-justify mb-4" style="max-width:@AppData.MaxWidth;">
                For accurate predictions, results must be duly modified
                or qualified according to the affliction or otherwise of the
                planets concerned. For example, predictions involving planets with
                high strength (Bhava Bala), is often accurate.
            </p>
        </Content>
    </PageHelpSection>

</div>

@code {

    private PeopleSelectorBox? _peopleSelectorBox;
    private List<HoroscopePrediction> _horoscopePredictions = new();
    private List<HoroscopePrediction> _filteredHoroscopePredictions = new();
    private string _searchInput = "";

    private ElementReference holder;
    private PageHelpSection _helpSection;



    //█░░ █ █▀▀ █▀▀ █▀▀ █▄█ █▀▀ █░░ █▀▀   █▀▄▀█ █▀▀ ▀█▀ █░█ █▀█ █▀▄ █▀
    //█▄▄ █ █▀░ ██▄ █▄▄ ░█░ █▄▄ █▄▄ ██▄   █░▀░█ ██▄ ░█░ █▀█ █▄█ █▄▀ ▄█
    //METHODS THAT CAN IMPLEMENT ASYNC ERROR HANDLER

    private async Task SearchButtonClicked() => await InvokeAsync(async () => await _SearchButtonClicked()).Try(_jsRuntime);
    private async Task CalculateButtonClicked() => await InvokeAsync(async () => await _CalculateButtonClicked()).Try(_jsRuntime);





    //█▀█ █▀█ █ █░█ ▄▀█ ▀█▀ █▀▀   █▀▄▀█ █▀▀ ▀█▀ █░█ █▀█ █▀▄ █▀
    //█▀▀ █▀▄ █ ▀▄▀ █▀█ ░█░ ██▄   █░▀░█ ██▄ ░█░ █▀█ █▄█ █▄▀ ▄█


    private async Task _SearchButtonClicked()
    {
        //if no search text means reset (no filter applied)
        if (_searchInput == "") { _filteredHoroscopePredictions = _horoscopePredictions.ToList(); return; }

        //else search by text
        _filteredHoroscopePredictions = _horoscopePredictions.FindAll(x => x.Contains(_searchInput));
    }


    private async Task _CalculateButtonClicked()
    {
        //only continue if passed input field validation
        if (!ValidationPassed()) { return; }

        //show loading
        _jsRuntime.ShowLoading();

        await CalculateAndUpdateEvents();

        //make table and search visible
        await _jsRuntime.Show(holder);

        _jsRuntime.HideAlert();
    }

    /// <summary>
    /// Checks if validation of all input fields
    /// </summary>
    private bool ValidationPassed()
    {
        var isValid = true;

        //TEST 1
        //if person not selected, invalid
        if (!_peopleSelectorBox.IsPersonSelected)
        {
            //mark invalid & alert user
            isValid = false;
            _jsRuntime.ShowAlert("error", AlertText.NoName, true);
        }


        return isValid;
    }


    private async Task CalculateAndUpdateEvents()
    {
        //get person from person dropdown
        var person = _peopleSelectorBox.GetSelectedPerson();

        //get main horoscope prediction file (located in wwwroot)
        var predictionDataList = await Client.GetStreamAsync("data/PredictionDataList.xml");

        //calculate predictions for current person (client side)
        _horoscopePredictions = await HoroscopeCore.GetPrediction(person, predictionDataList);
        _filteredHoroscopePredictions = _horoscopePredictions.ToList(); //make a copy for search

        StateHasChanged();
    }



}
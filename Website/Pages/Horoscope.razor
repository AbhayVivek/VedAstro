@using System.Xml.Linq
@using Genso.Astrology.Library
@attribute [Route(PageRoute.Horoscope)]
@attribute [Route(PageRoute.HoroscopeParam)]

@inject HttpClient Client


<PageTitle>@_pageTitle</PageTitle>

<PageTop Title="Horoscope" IconName="fluent:book-star-20-filled">
    <Description>Astrological predictions of a person's horoscope.<br />Over +370 planetary combinations are checked.</Description>
    <ButtonsRow>
        <IconButton IconName="ant-design:user-add-outlined" ButtonText="Add Person" ClickUrl="@PageRoute.AddPerson"></IconButton>
        <IconButton IconName="carbon:graphical-data-flow" ButtonText="Horoscope Data" ClickUrl="@PageRoute.HoroscopeData"></IconButton>
        <IconButton IconName="bx:book-reader" ButtonText="Help" OnClickCallback="@_helpSection.Show"></IconButton>
    </ButtonsRow>
</PageTop>


<div>

    @*SELECTOR & BUTTON*@
    <div class="d-flex flex-wrap">
        <div class="vstack gap-3">
            <PeopleSelectorBox @ref="_peopleSelectorBox" />
            <IconButton IconName="uim:process" ButtonText="Calculate" OnClickCallback="CalculateButtonClicked"></IconButton>
        </div>
        <div class="alert alert-warning d-flex align-items-center w-50" role="alert">
            <span class="iconify bi flex-shrink-0 me-2" data-icon="ant-design:warning-twotone" data-width="50"></span>
            <div>
                <strong>Remember!</strong><br />
                Results shown here need to be combined with <a href="@PageRoute.HoroscopeData"><span class="fw-bold">Astrological Data</span></a> to get accurate predictions.
                Every combination mentioned should be applied to the Rasi, Bhava and Navamsa charts and then a conclusion drawn.
            </div>
        </div>
    </div>

    @*divider*@
    <hr />

    @*RESULTS MULTIPLE TABS*@
    @if (_isReady)
    {
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">
                    <Icon IconName="majesticons:scroll-text-line" />
                    Prediction
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="false">
                    <Icon IconName="bi:clipboard-data-fill" />
                    Data
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="traditional-tab" data-bs-toggle="tab" data-bs-target="#traditional" type="button" role="tab" aria-controls="traditional" aria-selected="false">
                    <Icon IconName="ph:squares-four-fill" />
                    Traditional Chart
                </button>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                <div class="vstack gap-2 p-2">

                    @*FILTER*@
                    <div class="vstack gap-3">
                        <div class="border border-1">
                            <div class="hstack">
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_sunCheckBox" /><label class="form-check-label">Sun</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_moonCheckBox" /><label class="form-check-label">Moon</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_marsCheckBox" /><label class="form-check-label">Mars</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_mercuryCheckBox" /><label class="form-check-label">Mercury</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_jupiterCheckBox" /><label class="form-check-label">Jupiter</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_venusCheckBox" /><label class="form-check-label">Venus</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_saturnCheckBox" /><label class="form-check-label">Saturn</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_rahuCheckBox" /><label class="form-check-label">Rahu</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_ketuCheckBox" /><label class="form-check-label">Ketu</label></div></div>
                            </div>
                        </div>
                        <div class="border border-1">
                            <div class="hstack">
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_house1CheckBox" /><label class="form-check-label"> 1</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_house2CheckBox" /><label class="form-check-label"> 2</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_house3CheckBox" /><label class="form-check-label"> 3</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_house4CheckBox" /><label class="form-check-label"> 4</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_house5CheckBox" /><label class="form-check-label"> 5</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_house6CheckBox" /><label class="form-check-label"> 6</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_house7CheckBox" /><label class="form-check-label"> 7</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_house8CheckBox" /><label class="form-check-label"> 8</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_house9CheckBox" /><label class="form-check-label"> 9</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_house10CheckBox" /><label class="form-check-label"> 10</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_house11CheckBox" /><label class="form-check-label"> 11</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_house12CheckBox" /><label class="form-check-label"> 12</label></div></div>
                            </div>
                        </div>
                        <div class="border border-1">
                            <div class="hstack">
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_ariesCheckBox" /><label class="form-check-label">Aries</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_taurusCheckBox" /><label class="form-check-label">Taurus</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_geminiCheckBox" /><label class="form-check-label">Gemini</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_cancerCheckBox" /><label class="form-check-label">Cancer</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_leoCheckBox" /><label class="form-check-label">Leo</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_virgoCheckBox" /><label class="form-check-label">Virgo</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_libraCheckBox" /><label class="form-check-label">Libra</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_scorpioCheckBox" /><label class="form-check-label">Scorpio</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_sagittariusCheckBox" /><label class="form-check-label">Sagittarius</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_capricornusCheckBox" /><label class="form-check-label">Capricornus</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_aquariusCheckBox" /><label class="form-check-label">Aquarius</label></div></div>
                                <div class="p-2"><div class="form-check"><input type="checkbox" class="form-check-input" @bind="_piscesCheckBox" /><label class="form-check-label">Pisces</label></div></div>
                            </div>
                        </div>
                    </div>
                    <IconButton ButtonText="Refresh Filter" IconName="bx:search-alt" OnClickCallback="FilterButtonClicked"></IconButton>
                    @*SEARCH*@
                    @*                    <div class="hstack gap-3">
                <input @bind="_searchInput" type="text" class="form-control" placeholder="Search">
                <IconButton ButtonText="Search" IconName="bx:search-alt" OnClickCallback="SearchButtonClicked"></IconButton>
                </div>
                *@
                    @*LIST OF PREDICTIONS*@
                    <table class="table table-bordered table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th style="min-width: 123px;">Tags</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var prediction in _filteredHoroscopePredictions)
                            {
                                <tr>
                                    <td>@prediction.FormattedName</td>
                                    <td>@prediction.Description</td>
                                    <td>@prediction.RelatedBody</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            @*DATA CHART*@
            <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                <div class="vstack gap-3">

                    <StrengthChart Time="@_selectedPerson.BirthTime" />
                    <hr>
                    <PlanetHouseInfoViewer Time="@_selectedPerson.BirthTime" />

                </div>
            </div>

            @*TRADITIONAL CHART*@
            <div class="tab-pane fade" id="traditional" role="tabpanel" aria-labelledby="traditional-tab">
                <div class="vstack gap-3 p-4">
                    <h4>Under construction...</h4>
                    <h4>
                        <a href="@PageRoute.Donate" class="link-primary">Donate</a> to help build this faster.
                    </h4>

                </div>
            </div>
        </div>

    }



    @*HELP SECTION*@
    <PageHelpSection @ref="_helpSection">
        <Content>
            <h4 class="fw-bold">How to use these predictions?</h4>
            <p class="text-justify mb-4" style="max-width:@AppData.MaxWidth;">
                For accurate predictions, results must be duly modified
                or qualified according to the affliction or otherwise of the
                planets concerned. For example, predictions involving planets with
                high strength (Bhava Bala), is often accurate.
            </p>

            <h4 class="fw-bold">Where are these predictions from?</h4>
            <p class="text-justify mb-4" style="max-width:@AppData.MaxWidth;">
                Prediction data come from books by renowned astrologer B.V. Raman.
                Books such as <span class="fw-bold">How to Judge Horoscope</span> and
                <span class="fw-bold">Hindu Predictive Astrology</span>,
                were used to make this calculator.
            </p>
        </Content>
    </PageHelpSection>

</div>


@code {

    private bool _sunCheckBox, _moonCheckBox, _marsCheckBox, _mercuryCheckBox, _jupiterCheckBox, _venusCheckBox, _saturnCheckBox, _rahuCheckBox, _ketuCheckBox;
    private bool _house1CheckBox, _house2CheckBox, _house3CheckBox, _house4CheckBox, _house5CheckBox, _house6CheckBox, _house7CheckBox, _house8CheckBox, _house9CheckBox, _house10CheckBox, _house11CheckBox, _house12CheckBox;
    private bool _ariesCheckBox, _taurusCheckBox, _geminiCheckBox, _cancerCheckBox, _leoCheckBox, _virgoCheckBox, _libraCheckBox, _scorpioCheckBox, _sagittariusCheckBox, _capricornusCheckBox, _aquariusCheckBox, _piscesCheckBox;


    /// <summary>
    /// Param used in URL to set Person ID via URL
    /// </summary>
    [Parameter]
    public string PersonIdUrl { get; set; } = "";

    private string _pageTitle = "Horoscope";
    private PeopleSelectorBox? _peopleSelectorBox;
    private List<HoroscopePrediction>? _horoscopePredictions;
    private List<HoroscopePrediction>? _filteredHoroscopePredictions;
    private string _searchInput = "";
    private Person _selectedPerson;

    private PageHelpSection _helpSection;

    private bool _isReady = false;


    //█░░ █ █▀▀ █▀▀ █▀▀ █▄█ █▀▀ █░░ █▀▀   █▀▄▀█ █▀▀ ▀█▀ █░█ █▀█ █▀▄ █▀
    //█▄▄ █ █▀░ ██▄ █▄▄ ░█░ █▄▄ █▄▄ ██▄   █░▀░█ ██▄ ░█░ █▀█ █▄█ █▄▀ ▄█
    //METHODS THAT CAN IMPLEMENT ASYNC ERROR HANDLER

    private async Task SearchButtonClicked() => await InvokeAsync(async () => await _SearchButtonClicked()).Try(_jsRuntime);
    private async Task FilterButtonClicked() => await InvokeAsync(async () => await _FilterButtonClicked()).Try(_jsRuntime);

    private async Task CalculateButtonClicked() => await InvokeAsync(async () => await _CalculateAndUpdateEvents()).Try(_jsRuntime);

    protected override async Task OnAfterRenderAsync(bool firstRender) => await InvokeAsync(async () => await _OnAfterRenderAsync(firstRender)).Try(_jsRuntime);





    //█▀█ █▀█ █ █░█ ▄▀█ ▀█▀ █▀▀   █▀▄▀█ █▀▀ ▀█▀ █░█ █▀█ █▀▄ █▀
    //█▀▀ █▀▄ █ ▀▄▀ █▀█ ░█░ ██▄   █░▀░█ ██▄ ░█░ █▀█ █▄█ █▄▀ ▄█

    private async Task _OnAfterRenderAsync(bool firstRender)
    {
        //if parameter has been set then auto load person data as
        //though person was selected and calculate was clicked
        if (PersonIdUrl != null && firstRender)
        {
            await _jsRuntime.ShowLoading();

            //programmatically select the person
            await _peopleSelectorBox.SetPerson(PersonIdUrl);

            //start the same process as show button click
            //todo loading box disappears here, needs fix
            await _CalculateAndUpdateEvents();

            //needed to see updates because any changes in OnAfterRender
            //have to be manually set
            StateHasChanged();

            _jsRuntime.HideLoading();
        }
    }
    private async Task _SearchButtonClicked()
    {
        await _jsRuntime.ShowLoading();

        //if no search text means reset (no filter applied)
        if (_searchInput == "") { _filteredHoroscopePredictions = _horoscopePredictions.ToList(); return; }

        //else search by text
        _filteredHoroscopePredictions = _horoscopePredictions.FindAll(x => x.Contains(_searchInput));

        _jsRuntime.HideLoading();
    }

    private async Task _FilterButtonClicked()
    {
        await _jsRuntime.ShowLoading();


        var listToShow = new List<HoroscopePrediction>();
        foreach (var horoPredic in _horoscopePredictions)
        {

            //if there is a match between the prediction's related bodies & the user's selected filter planets,
            //then the prediction meets the planet filter, should be included in list

            //check match planet
            var selectedPlanetFilters = GetSelectedPlanetFilters();
            var matchPlanet = horoPredic.RelatedBody.RelatedPlanets.Intersect(selectedPlanetFilters).ToList().Any();

            //check match house
            var selectedHouseFilters = GetSelectedHouseFilters();
            var matchHouse = horoPredic.RelatedBody.RelatedHouses.Intersect(selectedHouseFilters).ToList().Any();

            //check match zodiac
            var selectedZodiacFilters = GetSelectedZodiacFilters();
            var matchZodiac = horoPredic.RelatedBody.RelatedZodiac.Intersect(selectedZodiacFilters).ToList().Any();

            //add to list if any of the matched passed
            var addInList = matchPlanet || matchHouse || matchZodiac;
            if (addInList) { listToShow.Add(horoPredic); }
        }

        //update view (empty list will be handled by blazor side)
        _filteredHoroscopePredictions = listToShow;

        _jsRuntime.HideLoading();
    }

    /// <summary>
    /// Checks if validation of all input fields
    /// </summary>
    private async Task<bool> ValidationPassed()
    {

        //TEST 1
        //if person not selected, invalid
        if (!_peopleSelectorBox.IsPersonSelected)
        {
            //mark invalid & alert user
            await _jsRuntime.ShowAlert("error", AlertText.SelectName, true);
            return false;
        }

        return true;
    }

    private async Task _CalculateAndUpdateEvents()
    {
        await _jsRuntime.ShowLoading();

        //only continue if passed input field validation
        if (!await ValidationPassed()) { return; }

        //hide data while loading, only after validation
        _isReady = false;

        //get person from person dropdown
        _selectedPerson = await _peopleSelectorBox.GetSelectedPerson();

        //only set url if not already set
        //note:this improves UX, as links can lead faster to data
        PersonIdUrl = _selectedPerson.Id; //save local copy
        _navigation.NavigateTo($"{PageRoute.Horoscope}/{PersonIdUrl}"); //change url

        //put person name into tab title for easy multi-tabbing
        _pageTitle = $"Horoscope | {_selectedPerson.Name}";

        //get horoscope predictions from API server
        var personIdXml = new XElement("PersonId", _selectedPerson.Id);
        var rootXml = await ServerManager.WriteToServerXmlReply(ServerManager.GetHoroscope, personIdXml, _jsRuntime);

        //parse xml horoscope predictions
        _horoscopePredictions = HoroscopePrediction.FromXmlList(rootXml);

        _filteredHoroscopePredictions = _horoscopePredictions.ToList(); //make a copy for search

        _isReady = true;

        //close loading box
        _jsRuntime.HideAlert();
    }


    /// <summary>
    /// Returns a list of planets selected by user
    /// to ONLY include in results
    /// </summary>
    /// <returns></returns>
    private List<PlanetName> GetSelectedPlanetFilters()
    {
        var returnList = new List<PlanetName>();

        if (_sunCheckBox) { returnList.Add(PlanetName.Sun); }
        if (_moonCheckBox) { returnList.Add(PlanetName.Moon); }
        if (_marsCheckBox) { returnList.Add(PlanetName.Mars); }
        if (_mercuryCheckBox) { returnList.Add(PlanetName.Mercury); }
        if (_jupiterCheckBox) { returnList.Add(PlanetName.Jupiter); }
        if (_venusCheckBox) { returnList.Add(PlanetName.Venus); }
        if (_saturnCheckBox) { returnList.Add(PlanetName.Saturn); }
        if (_rahuCheckBox) { returnList.Add(PlanetName.Rahu); }
        if (_ketuCheckBox) { returnList.Add(PlanetName.Ketu); }

        return returnList;
    }

    /// <summary>
    /// Returns a list of houses selected by user
    /// to ONLY include in results
    /// </summary>
    /// <returns></returns>
    private List<HouseName> GetSelectedHouseFilters()
    {
        var returnList = new List<HouseName>();

        if (_house1CheckBox) { returnList.Add(HouseName.House1); }
        if (_house2CheckBox) { returnList.Add(HouseName.House2); }
        if (_house3CheckBox) { returnList.Add(HouseName.House3); }
        if (_house4CheckBox) { returnList.Add(HouseName.House4); }
        if (_house5CheckBox) { returnList.Add(HouseName.House5); }
        if (_house6CheckBox) { returnList.Add(HouseName.House6); }
        if (_house7CheckBox) { returnList.Add(HouseName.House7); }
        if (_house8CheckBox) { returnList.Add(HouseName.House8); }
        if (_house9CheckBox) { returnList.Add(HouseName.House9); }
        if (_house10CheckBox) { returnList.Add(HouseName.House10); }
        if (_house11CheckBox) { returnList.Add(HouseName.House11); }
        if (_house12CheckBox) { returnList.Add(HouseName.House12); }

        return returnList;
    }

    /// <summary>
    /// Returns a list of zodiac name selected by user
    /// to ONLY include in results
    /// </summary>
    /// <returns></returns>
    private List<ZodiacName> GetSelectedZodiacFilters()
    {
        var returnList = new List<ZodiacName>();

        if (_ariesCheckBox) { returnList.Add(ZodiacName.Aries); }
        if (_taurusCheckBox) { returnList.Add(ZodiacName.Taurus); }
        if (_geminiCheckBox) { returnList.Add(ZodiacName.Gemini); }
        if (_cancerCheckBox) { returnList.Add(ZodiacName.Cancer); }
        if (_leoCheckBox) { returnList.Add(ZodiacName.Leo); }
        if (_virgoCheckBox) { returnList.Add(ZodiacName.Virgo); }
        if (_libraCheckBox) { returnList.Add(ZodiacName.Libra); }
        if (_scorpioCheckBox) { returnList.Add(ZodiacName.Scorpio); }
        if (_sagittariusCheckBox) { returnList.Add(ZodiacName.Sagittarius); }
        if (_capricornusCheckBox) { returnList.Add(ZodiacName.Capricornus); }
        if (_aquariusCheckBox) { returnList.Add(ZodiacName.Aquarius); }
        if (_piscesCheckBox) { returnList.Add(ZodiacName.Pisces); }

        return returnList;
    }

}
@using Website
@using System.Text.Json.Nodes
@using System.Xml.Linq
@using Genso.Astrology.Library

<style>

    #GoogleSignInButton {
        text-align: -webkit-center;
        position: relative;
    }

    #FacebookSignInButton {
        width: 150px;
        align-self: center;
        border-radius: 30px;
        padding-left: 29px;
    }

</style>

@*Colored box behind login/logout button*@
<div class="rounded" style="background: rgba(0, 255, 255, 0.1)">

    @if (AppData.CurrentUser != UserData.Empty)
    {
        <div class="vstack gap-1" style="padding: 6px;">
            <span class="" style="align-self: center;padding: 10px; color: white;">@($"Hi, {AppData.CurrentUser?.Name}")</span>
            @*default hide Sign Out button*@
            <button @onclick="OnClickSignOutButton" class="btn btn-primary">Sign Out</button>
        </div>
    }
    else
    {

        <div class="vstack gap-2">
            @*FACEBOOK Sign In button*@
            <button id="FacebookSignInButton" @onclick="OnClickSignInFacebook" class="btn btn-primary hstack gap-2 iconButton">
                <span class="iconify" data-icon="akar-icons:facebook-fill" data-width="25"></span> Sign In
            </button>

            @*GOOGLE Sign In button*@
            <div>

                <div id="g_id_onload"
                 data-client_id="19638836771-oflt5g9mnkft6chkl04vp4m5qpu5h569.apps.googleusercontent.com"
                 data-context="signin"
                 data-ux_mode="popup"
                 data-callback="OnGoogleSignInSuccessHandler"
                 data-auto_prompt="false">
                </div>

                <div class="g_id_signin"
                 data-type="standard"
                 data-shape="pill"
                 data-theme="outline"
                 data-text="signin"
                 data-size="large"
                 data-logo_alignment="center"
                 data-width="150"
                 id="GoogleSignInButton">
                </div>
            </div>

        </div>
    }
</div>

@code {



    //▒█▀▄▀█ ▒█▀▀▀ ▀▀█▀▀ ▒█░▒█ ▒█▀▀▀█ ▒█▀▀▄ ▒█▀▀▀█
    //▒█▒█▒█ ▒█▀▀▀ ░▒█░░ ▒█▀▀█ ▒█░░▒█ ▒█░▒█ ░▀▀▀▄▄
    //▒█░░▒█ ▒█▄▄▄ ░▒█░░ ▒█░▒█ ▒█▄▄▄█ ▒█▄▄▀ ▒█▄▄▄█

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            //google sign in code must be only loaded after
            //special google button has been rendered
            await _jsRuntime.InvokeVoidAsync("loadJs", ServerManager.GoogleSignInJs);

            //makes this components instance available in JS,
            //to be used later when user clicks sign in button
            await _jsRuntime.InvokeVoidAsync("SignInButtonInstance", DotNetObjectReference.Create(this));
        }
    }


    /// <summary>
    /// This method is called from JS when user signs in
    /// note: works because SignInButtonInstance was called earlier
    /// </summary>
    [JSInvokable]
    public async Task OnGoogleSignInSuccessHandler(JsonNode credentialResponse)
    {

#if DEBUG
    Console.WriteLine("BLZ: OnGoogleSignInSuccessHandler");
#endif

        //todo show loading box

        //get the ID Token/JWT from the response
        var idToken = (string)credentialResponse["credential"]!;

        //send token to api for verification
        var rootXml = await ServerManager.WriteToServerXmlReply(ServerManager.SignInGoogle, new XElement("Token", idToken));

        //check if reply is pass or fail
        var isPass = ServerManager.IsReplyPass(rootXml);

        if (isPass)
        {
            //get payload containing user data
            var userDataXml = ServerManager.GetPayload(rootXml);

            //initialize user data & store it for access by the rest of the app
            AppData.CurrentUser = UserData.FromXml(userDataXml);

            //store user data (xml) in browser localstorage
            await _jsRuntime.SetProperty("UserData", AppData.CurrentUser.ToXml().ToString());

            //refresh page
            WebsiteTools.ReloadPage(_navigation);
        }
        else
        {
            //TODO
            //show login failed message to user
            //note: this failure is already logged in API
        }


    }

    private async Task OnClickSignOutButton()
    {
        //clear local storage of user data
        //since login status is basically the existence of user data in localstorage
        //removing it removes user's login
        await _jsRuntime.RemoveProperty("UserData");

        //refresh page
        WebsiteTools.ReloadPage(_navigation);

    }



    /// <summary>
    /// This method is called from JS when user signs in
    /// note: works because SignInButtonInstance was called earlier
    /// </summary>
    [JSInvokable]
    public async Task OnFacebookSignInSuccessHandler(JsonNode response)
    {
        var authResponse = response["authResponse"];
        //login failed, let user know, and exit here
        if (authResponse == null) { return; }

        //login success, get token out
        var accessToken = (string)(authResponse["accessToken"])!;

        //send token to api for verification
        var rootXml = await ServerManager.WriteToServerXmlReply(ServerManager.SignInFacebook, new XElement("Token", accessToken));

        //check if reply is pass or fail
        var isPass = ServerManager.IsReplyPass(rootXml);

        if (isPass)
        {
            //get payload containing user data
            var userDataXml = ServerManager.GetPayload(rootXml);

            //initialize user data & store it for access by the rest of the app
            AppData.CurrentUser = UserData.FromXml(userDataXml);

            //store in browser localstorage
            await _jsRuntime.SetProperty("UserData", AppData.CurrentUser.ToXml().ToString());

            //refresh page
            WebsiteTools.ReloadPage(_navigation);
        }
        else
        {
            //TODO
            //show login failed message to user
            //note: this failure is already logged in API
        }
    }


    /// <summary>
    /// Starts facebook login process
    /// </summary>
    private void OnClickSignInFacebook() => _jsRuntime.InvokeVoidAsync("facebookLogin");


}
